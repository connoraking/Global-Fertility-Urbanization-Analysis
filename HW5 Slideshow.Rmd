---
title: "Fertility Rate of Countries Based on Urban Concentration"
author: "Connor King, Qilu Zhou, Chris Gresehover"
date: "3/29/2023"
runtime: shiny
output:
  ioslides_presentation:
    widescreen: true
    incremental: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, import, include=FALSE}
library(tidyverse)
library(countrycode)
library(plotly)
library(shiny)
```

```{css, echo=FALSE}
iframe {
  height: 700px;
  width: 109%;
  margin-left: -45px;
  margin-top: -90px;
  margin-bottom: -45px;
}

.table{
  width:auto;
  font-size: 12px;
}

.small .table{
  font-size: 10px;
}
```

```{r, data, include=FALSE}
fertility_data <- read.csv("fertility data.csv")
urban_data <- read.csv("urban data.csv")

urban_pop <- urban_data[-(1:291), ]

#pivoting while preventing creating multiple rows for the same year
urban_pop <- urban_pop %>%
  pivot_wider(id_cols = colnames(urban_pop)[2:3], names_from = X.1, values_from = X.4)


#renaming the columns 
urban_df <- urban_pop %>%
  rename(country = Population.and.rates.of.growth.in.urban.areas.and.capital.cities,
         year = X,
         urban_pop_percent = `Urban population (percent)`,
         urban_growth = `Urban population (percent growth rate per annum)`,
         rural_growth = `Rural population (percent growth rate per annum)`,
         cap_city_pop = `Capital city population (thousands)`,
         cap_percent_pop = `Capital city population (as a percentage of total population)`,
         cap_percent_urban = `Capital city population (as a percentage of total urban population)`)

### Fertility Data Cleaning

# Selecting the desired fertility stats:
fert1 <- fertility_data %>%
  filter(X.1 != "Population annual rate of increase (percent)", 
         X.1 != "Series", 
         X.1 != "Maternal mortality ratio (deaths per 100,000 population)")

#dropping the irrelevant columns
fert1 <- fert1[ , -1]
fert2 <- subset(fert1, select = -c(`X.3`, `X.4`))

#creating separate columns for the desired statistics 
fert3 <- fert2 %>%
          pivot_wider(names_from = X.1, values_from = X.2)

#renaming the columns 
fert4 <- fert3 %>%
  rename(country = Population.growth.and.indicators.of.fertility.and.mortality,
         year = X,
         fertility_rate = `Total fertility rate (children per women)`,
         infant_morality_per_thousand = `Infant mortality for both sexes (per 1,000 live births)`,
         life_exp = `Life expectancy at birth for both sexes (years)`)

# Creating the gender ratio stat and then removing life exp of males and females:
fert5 <- fert4 %>%
          mutate(
            male = as.numeric(`Life expectancy at birth for males (years)`),
            female = as.numeric(`Life expectancy at birth for females (years)`),
            
            gender_ratio_lifeexp = male / female)

fert6 <- fert5 %>%
      subset(select = -c(male,female, `Life expectancy at birth for males (years)`, `Life expectancy at birth for females (years)`))


# Removing the regions and subregions and only including countries. This will be easier as we can use ``countrycode`` on the final data set to analyze continents and subregions.

fert7 <- fert6[-(1:118), ]

#fixing some values
fert7$country[fert7$country == 'Türkiye'] <- 'Turkey'

# Changing the 2017 reference year to 2018:
fert_df <- fert7 %>%
  mutate(year = ifelse(year == 2017, 2018, year))

head(fert_df)

### Combining the data sets

df <- left_join(urban_df, fert_df, by = c("country", "year"))

# Implementing ``countrycode`` so we can consider continents and subregions into analysis:

df$continent <- countrycode(df$country, origin = "country.name", destination = "un.region.name")
df$region <- countrycode(df$country, origin = "country.name", destination = "un.regionsub.name")


df$capital_pop = as.numeric(df$cap_city_pop)
df$urban_pop_percent = as.numeric(df$urban_pop_percent)
df$urban_growth = as.numeric(df$urban_growth)
df$rural_growth = as.numeric(df$rural_growth)
df$cap_percent_pop = as.numeric(df$cap_percent_pop)
df$fertility_rate = as.numeric(df$fertility_rate)

# if capital_pop is NA, label as 0; else 1
df$capital_pop_sign = ifelse(is.na(df$capital_pop), "0", "1")

# if capital_pop is NA, give the value of 1
df$capital_pop1 = ifelse(is.na(df$capital_pop), 1, df$capital_pop)

# if rural_growth<0, label as 0; else 1
df$sign = ifelse(df$rural_growth < 0, "0", "1")

# mark the missing value of rural_growth as missing
df$sign = ifelse(is.na(df$sign), "missing", df$sign)

write.csv(df, "test.csv")
```

```{r urban_percent, include = FALSE}
### fertility vs urban_percent

Sys.setlocale('LC_ALL','C')

df_year = subset(df, !is.na(continent))

urban = ggplot(df_year, aes(urban_pop_percent, fertility_rate, color = continent)) +
  geom_point(aes(ids = country, size = capital_pop1)) +
  theme(legend.title = element_blank()) +
#  scale_shape_manual(values = c("0" = 21, "1" = 20)) +
  ylim(0, 10) +
  xlim(0, 100) +
  xlab("urban population(percent)") +
  ylab("fertility rate") +
  guides(shape = "none") +
  guides(size = "none")


urban1 = ggplotly(urban)

```

```{r urban_growth, include=FALSE}
### fertility vs urban_growth

life = ggplot(df_year, aes(urban_growth, fertility_rate, color = continent)) +
  geom_point(aes(size = abs(rural_growth), shape = sign, ids = country)) +
  theme(legend.title = element_blank()) +
  ylim(0,10) +
  xlim(-2, 15) +
  scale_shape_manual(values = c("0" = 21, "1" = 20, "missing" = 2)) +
  xlab("urban population(percent growth rate)") +
  ylab("fertility rate") +
  guides(shape = guide_legend(title = "")) +
  guides(size = guide_legend(title = "")) 

life1 = ggplotly(life)

```

## Question

The question we chose was to see if urbanization indicated a higher fertility rate.


## Why

### Resource allocation and planning

- Understanding the relationship between urbanization and fertility rates can assist in determining the demand for resources and services in both urban and rural areas. 

- This information can be used by governments and organizations to allocate resources more effectively for things such as healthcare, education, housing, and infrastructure.

### Economic Development 

- High fertility rates can strain resources and services, while rapid urban growth may lead to challenges in providing adequate infrastructure, housing, and job opportunities. 

- Identifying these relationships can help inform strategies to promote sustainable development and economic growth.

## Data

- We obtained our data from the United Nations at data.un.org

- We used two separate datasets, one labeled “Population in the capital city, urban, and rural areas” and “Population growth, fertility, life expectancy, and mortality”

## Variables 

- There were several variables included in these two data sets; however, the ones we were interested in were **urban percentage**, **urban percentage growth**, **rural percentage growth**, and **fertility rate**.

- Urban percentage measures the percentage of the country living in urban areas (cities)

- Urban percentage growth measures the percentage growth of the urban areas per year  tracked over a 5-year period preceding the reference year.

- Rural percentage growth measures the percentage growth of rural areas per year  tracked over a 5-year period preceding the reference year.

## Proxies

- Urban population percentage is a proxy for the degree of urbanization, reflecting the proportion of the population living in urban areas. 

- Urban growth percentage and rural growth percentage are proxies for the rate at which urban and rural populations are changing, respectively, indicating the dynamics of urbanization over time.

## Data Cleaning/Combining {.build}

- The variables of interest were under a “series” column so we used pivot_wider from ``tidyr`` to create separate columns and ensure the data was tidy. 

- Within each data set we dropped irrelevant data, and renamed the columns.

- Our fertility dataset had the reference year of 2022. Since our urban data set did not have this year, we used left_join when combining the datasets which drops the year within our finished dataset.

- We then used the ``countrycode`` so we could analyze the data pertaining to continents and subregions.  

## Visualization

### Fertility vs urban population(percent)

- Size
  - Capital population(thousands)

- Ellipse shape
  - Countries with high percent of urban population tend to have low fertility rate
  - Africa has the highest average fertility rate while Europe has the lowest
  - Fertility rate and urban population percent are negatively related

## Visualization

### Fertility vs urban population(percent)

```{r urban_percent show, echo=FALSE, warning=FALSE}
urban1
```

## Visualization

### Fertility vs urban population(percent) sub-region

- High urban population > 75%
  - Northern American, Western Europe, Australia and New Zealand
  - Variances in fertility rate and urban population percent are the smallest in Europe

- High fertility rate
  - Sub-Sarahan Africa women has more than 4 children in average

## Visualization

### Fertility vs urban growth

- Shape
  - Filled: positive rural growth
  - Unfilled: negative rural growth

- Size
  - absolute value of rural growth
  
- Fertility rate and urban growth are positively almost linearly correlated
  - Africa has the largest urban growth rate while Europe has the smallest
  - Urban growth in Europe is very slow, mostly between -2% to 2%

- There are some countries with negative urban growth rates


## Visualization

### Fertility vs urban growth

```{r urban_growth show, echo=FALSE, warning=FALSE}
life1
```

## Visualization

### Fertility vs urban growth sub-region

- Northern Africa 
  - Positive urban growth rate
  
- Western Asia
  - Countries with negative urban growth all have negative rural growth

- Northern America
  - Urban growth between -1% to 1%

## Shiny App Methodology {.build}

- Define inputs for `sidebarPanel` from:
  - Plot axes (fertility rate, urban percentage, urban growth percentage)
  - Other point aesthetics (continent, sub-region, year, rural growth percentage)
  
- Showing checkboxes for all sub-regions would have been visually overwhelming
  - Server function `observeEvent` can check for changes to the continent filter so that sub-regions are shown when only one continent is selected

##

```{r, app-launch, echo=FALSE, warning=FALSE}
shinyAppFile(
  paste(getwd(), "Hw5 app.R", sep = "/")
)
```

## Weaknesses {.build}

- In the Urban data set, one of the reference years is 2017 while one of the reference years was 2018 in the fertility data set. Since the 2018 data is valid for the previous 4 years, we decided to use the 2017 reference period as congruent to the 2018 reference period.

- For weaknesses in the data itself, UN data is often based on information provided by individual countries, and the quality of this information can vary significantly depending on each country's data collection and reporting practices.

## Assumptions and Limitations {.build}

To populate the available input years, a summary of the number of observations in each year that contained non-NA values for **fertility rate** and at least one of **urban percentage** and **urban percentage growth**.

<div class="small">
```{r, validity, echo=FALSE}
validity =
  df %>%
    mutate(
      valid_fert = !is.na(fertility_rate),
      valid_urb = !is.na(urban_pop_percent),
      valid_grow = !is.na(urban_growth),
      valid = !is.na(fertility_rate) & !(is.na(urban_pop_percent) & is.na(urban_growth))
    ) %>%
    mutate(
      valid_type = ifelse(valid & valid_grow, "valid",
                   ifelse(valid & !valid_grow, "urb_valid_only",
                   ifelse(!valid_grow, "partial_X_only", "no_Y")))
    ) %>%
    group_by(
      year,
      valid_type
    ) %>%
    count() %>%
    pivot_wider(names_from = valid_type, values_from = n) %>%
    select(year, valid, urb_valid_only, no_Y, partial_X_only)

validity %>%
  knitr::kable(
    format = "html",
    align = "c",
    caption = "Data Availability by Year",
    col.names = c("Year", "Valid (Both Plots)", "Valid (Urban % Plot Only)", "No Fertility Data", "No Fertility / Urban Growth Data")
  ) %>%
  kableExtra::column_spec(c(2, 3), bold = TRUE, color = "white", background = "#4e8223") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))
```
</div>

Valid years can then be calculated as a sum of the valid columns:
```{r, valid_years, echo=TRUE}
valid_yrs = validity$year[!is.na(validity$valid) | !is.na(validity$urb_valid_only)]
valid_yrs_both_plots = validity$year[!is.na(validity$valid)]
```

## Assumptions and Limitations {.build}

- Slider input ranges were set manually by buffering the min and max values for each respective input to round numbers.

- The initial view of the app includes all but a few upper outliers in **urban growth percentage**.
  - Providing a different default filter (or even buttons to load specific views) could shape the impression of a viewer

- Filtering to show just Africa and Europe demonstrates the relationship between fertility rate and growing urban populations that aren't already a large portion of a country's population (i.e. high growth but low urban percentage).
  - Further filtering to Africa alone shows the same pattern between Northern Africa and Sub-Saharan countries.
  
## Assumptions and Limitations {.build}

- However, the patterns visualized could also just be confirming prior knowledge of developing countries.
  
- *Correlation* may be present, but the data doesn't necessarily show direct causation
  - Qatar (2010) and UAE (2010) both have high urban growth but relatively low fertility rates
  
```{r, plot-outliers-prep, include=FALSE}
df_outliers = df %>%
  mutate(outlier = (country == "Qatar" | country == "United Arab Emirates") & year == 2010)

life = ggplot(df_outliers, aes(x = urban_growth, y = fertility_rate, color = outlier))

plt_lbls = as.list(life$data %>%
  transmute(lbl = paste0(
    "<b>Country: ", country, "</b><br>",
    "Continent: ", continent, "<br>",
    "Year: ", year, "<br>",
    "Fertility Rate: ", fertility_rate, "<br>",
    "Urban Growth %: ", urban_growth, "<br>",
    "Rural Growth %: ", ifelse(sign == "0", paste0("<b>", rural_growth, "</b>"), rural_growth)
  )))[["lbl"]]

life = life +
  geom_point(aes(size = abs(rural_growth), text = plt_lbls)) +
  theme(legend.title = element_blank()) +
  ylim(0, 10) +
  xlab("urban population(percent)") +
  ylab("fertility rate") +
  guides(size = "none") +
  guides(color = "none")
```

```{r, plot_outliers, echo=FALSE}
ggplotly(life, tooltip = c("text"), height = 250)
```

## Conclusion

- Urban percentage and urban growth rate
  - Negatively correlated
  - Developing countries are more energetic

- Negative urban growth rate
  - Positive rural growth rate: rural gentrification
    - Affluent individuals and families from urban areas to rural areas
  - Negative rural growth rate: emigration or brain drain
    - Emigration of highly skilled or educated individuals, often happens in islands

## Thanks!
